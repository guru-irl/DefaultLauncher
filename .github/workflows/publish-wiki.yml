name: Publish wiki

on:
  push:
    branches: [main]
    paths:
      - docs/**
      - .github/workflows/publish-wiki.yml

permissions:
  contents: write

jobs:
  publish-wiki:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Prepare wiki content
        run: |
          cp -r docs wiki-stage

          # README.md → Home.md (wiki landing page)
          mv wiki-stage/README.md wiki-stage/Home.md

          # GitHub wiki flattens pages to root level and doesn't use .md in links.
          # Rewrite markdown links: strip subdirectory prefixes and .md suffixes.
          # Also rewrite the Home link from README.md → Home.
          find wiki-stage -name '*.md' -exec sed -i -E \
            -e 's/\]\(README\.md\)/](Home)/g' \
            -e 's/\]\((changes|guides)\//](/g' \
            -e 's/\.md\)/)/' \
            {} +

          # Remove non-wiki files
          rm -rf wiki-stage/changes/banner*.svg \
                 wiki-stage/changes/GlyphToPath.java \
                 wiki-stage/changes/workflows/

      - uses: Andrew-Chen-Wang/github-wiki-action@v4
        with:
          strategy: init
          path: wiki-stage
